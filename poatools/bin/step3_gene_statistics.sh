#!/bin/bash

# POAtools - Step 3: Gene Statistics Calculation

if [[ $# -ne 2 ]]; then
    echo "Error: Step 3 script requires 2 parameters"
    echo "Usage: $0 <gene_classification_file> <output_directory>"
    echo ""
    echo "Description:"
    echo "  This script processes gene classification scores and calculates gene statistics"
    echo "  for each sample, including A, B, AB, NAB, AXB scores and nonzero site counts."
    echo ""
    echo "Parameters:"
    echo "  <gene_classification_file>  TSV file generated by Step 2 (gene_classification_scores.tsv)"
    echo "  <output_directory>          Directory for output TXT files"
    echo ""
    echo "Example:"
    echo "  $0 gene_classification_scores.tsv ./stats_output"
    exit 1
fi

INPUT_FILE="$1"
OUTPUT_DIR="$2"

echo "  Input file: $INPUT_FILE"
echo "  Output directory: $OUTPUT_DIR"

if [[ ! -f "$INPUT_FILE" ]]; then
    echo "Error: Input file does not exist: $INPUT_FILE"
    echo "Please run Step 2 first to generate the required input file"
    exit 1
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

echo "Starting Step 3: Gene Statistics Calculation..."
echo "Processing gene classification data..."

# Use awk to process the data and calculate statistics
awk -F'\t' '
BEGIN {
    # Initialize arrays to store data
    delete sample_data
    delete nonzero_counts
    delete gene_list
    OFS = "\t"  # Use tab as output separator for TXT files
}

NR == 1 {
    # Skip header
    next
}

{
    gene = $1
    sample = $2
    classification = $3
    score = $4
    
    # Store the original data for nonzero count calculation
    key = sample "|" gene
    if (score > 0) {
        nonzero_counts[key]++
    }
    
    # Track unique genes for sorting
    if (!(gene in gene_list)) {
        gene_list[gene] = 1
    }
    
    # Apply rule: when A, B or AB score is 1, add 1 to NAB score
    if ((classification == "A" || classification == "B" || classification == "AB") && score == 1) {
        # Store original record
        sample_data[sample "|" gene "|" classification] += score
        
        # Add NAB adjustment
        sample_data[sample "|" gene "|" "NAB"] += 1
    } else {
        # Store record as is
        sample_data[sample "|" gene "|" classification] += score
    }
}

END {
    # Process each sample
    delete processed_samples
    for (key in sample_data) {
        split(key, parts, "|")
        sample = parts[1]
        gene = parts[2]
        classification = parts[3]
        score = sample_data[key]
        
        if (!(sample in processed_samples)) {
            processed_samples[sample] = 1
        }
        
        # Initialize gene data for this sample if not exists
        if (!(sample "|" gene in gene_stats)) {
            gene_stats[sample "|" gene] = gene "\t0\t0\t0\t0\t0"
        }
        
        # Update the appropriate column based on classification
        split(gene_stats[sample "|" gene], stats, "\t")
        switch(classification) {
            case "A":
                stats[2] += score
                break
            case "B":
                stats[3] += score
                break
            case "AB":
                stats[4] += score
                break
            case "NAB":
                stats[5] += score
                break
            case "AXB":
                stats[6] += score
                break
        }
        gene_stats[sample "|" gene] = stats[1] "\t" stats[2] "\t" stats[3] "\t" stats[4] "\t" stats[5] "\t" stats[6]
    }
    
    # Create a sorted list of genes
    n = asorti(gene_list, sorted_genes)
    
    # Process each sample and output results
    for (sample in processed_samples) {
        # Create safe filename
        safe_filename = sample
        gsub(/[^a-zA-Z0-9]/, "_", safe_filename)
        output_file = "gene_stats_" safe_filename ".txt"  # Changed to .txt
        
        # Print header for this sample"s file
        print "Gene\tA\tB\tAB\tNAB\tAXB\tNonzero_Sites" > output_file
        
        # Print data for each gene in sorted order
        for (i = 1; i <= n; i++) {
            gene = sorted_genes[i]
            key = sample "|" gene
            
            if (key in gene_stats) {
                # Get nonzero count
                nonzero_key = sample "|" gene
                nonzero_count = (nonzero_key in nonzero_counts) ? nonzero_counts[nonzero_key] : 0
                
                # Print gene statistics
                print gene_stats[key] "\t" nonzero_count >> output_file
            }
        }
        
        # Count NAB adjustments for this sample
        nab_adjust_count = 0
        for (key in sample_data) {
            if (index(key, sample "|") == 1) {
                split(key, parts, "|")
                if (parts[3] == "NAB") {
                    # Check if this NAB was added due to adjustment
                    orig_key = sample "|" parts[2] "|" "A"
                    if (!(orig_key in sample_data) || sample_data[orig_key] != 1) {
                        orig_key = sample "|" parts[2] "|" "B"
                        if (!(orig_key in sample_data) || sample_data[orig_key] != 1) {
                            orig_key = sample "|" parts[2] "|" "AB"
                        }
                    }
                    if ((orig_key in sample_data) && sample_data[orig_key] == 1) {
                        nab_adjust_count++
                    }
                }
            }
        }
        
        print "Processed sample: " sample ", saved as: " output_file
        print "  Added NAB score for " nab_adjust_count " sites where A/B/AB score was 1"
    }
    
    print "All samples processed!"
}
' "$INPUT_FILE"

# Move all generated TXT files to output directory
mv gene_stats_*.txt "$OUTPUT_DIR" 2>/dev/null

exit_code=$?
if [[ $exit_code -eq 0 ]]; then
    echo "  Step 3 completed: Successfully generated gene statistics files in $OUTPUT_DIR"
    echo "  Generated files:"
    for file in "$OUTPUT_DIR"/gene_stats_*.txt; do
        if [[ -f "$file" ]]; then
            echo "    - $(basename "$file")"
        fi
    done
else
    echo "  Step 3 failed: Exit code $exit_code"
fi

exit $exit_code