#!/bin/bash

# POAtools - Step 2: Gene Classification Scoring

if [[ $# -ne 2 ]]; then
    echo "Error: Step 2 script requires 2 parameters"
    echo "Usage: $0 <step1_output_vcf> <output_file>"
    echo ""
    echo "Description:"
    echo "  This script processes the output from Step 1 (SNP density analysis)"
    echo "  and extracts gene classification scores."
    echo ""
    echo "Parameters:"
    echo "  <step1_output_vcf>  VCF file generated by Step 1 (contains classification data)"
    echo "  <output_file>       Output TSV file for gene classification scores"
    echo ""
    echo "Example:"
    echo "  $0 output/output.vcf.gz gene_classification_scores.tsv"
    exit 1
fi

STEP1_OUTPUT_VCF="$1"
OUTPUT_FILE="$2"

echo "  Step 1 output VCF: $STEP1_OUTPUT_VCF"
echo "  Output file: $OUTPUT_FILE"

if [[ ! -f "$STEP1_OUTPUT_VCF" ]]; then
    echo "Error: Step 1 output VCF file does not exist: $STEP1_OUTPUT_VCF"
    echo "Please run Step 1 first to generate the required input file"
    exit 1
fi

# Extract gene classification scores from Step 1 output
zcat "$STEP1_OUTPUT_VCF" | awk '
BEGIN {
    OFS = "\t";
    # Print header
    print "Gene", "Sample", "Classification", "Score";
}

/^#CHROM/ {
    # Extract sample names (from column 10 to last column)
    for (i = 10; i <= NF; i++) {
        sample_names[i] = $i;
    }
    next;
}

!/^#/ {
    # Extract gene information from INFO field
    gene = "Unknown";
    if (match($8, /GENE=([^;]+)/)) {
        gene = substr($8, RSTART+5, RLENGTH-5);
        split(gene, arr, ";");
        gene = arr[1];
    } else if (match($8, /ANN=[^|]+\|[^|]+\|[^|]+\|([^|]+)/)) {
        gene = substr($8, RSTART, RLENGTH);
        split(gene, arr, "|");
        gene = arr[4];
    }
    
    # Process each sample column (starting from column 10)
    for (i = 10; i <= NF; i++) {
        sample_name = sample_names[i];
        classification = $i;
        
        # Extract classification and score
        if (classification ~ /\([0-9]+\)$/) {
            # Extract classification name and score
            split(classification, parts, "(");
            class_name = parts[1];
            score = parts[2];
            gsub(/\)/, "", score);
            
            # Output result
            print gene, sample_name, class_name, score;
        } else if (classification != "Unknown") {
            # Handle cases without explicit score
            print gene, sample_name, classification, "1";
        }
    }
}' > "$OUTPUT_FILE"

exit_code=$?
if [[ $exit_code -eq 0 ]]; then
    echo "  Step 2 completed: Successfully generated $OUTPUT_FILE"
    echo "  Total lines generated: $(wc -l < "$OUTPUT_FILE")"
else
    echo "  Step 2 failed: Exit code $exit_code"
fi

exit $exit_code